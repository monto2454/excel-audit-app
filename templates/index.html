<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Excel Audit App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <style>
        body {
            background: #f5f7fb;
        }
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }
        .summary-card {
            position: sticky;
            top: 1rem;
        }
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
    </style>
</head>
<body>
<div class="loader-overlay" id="loaderOverlay">
    <div class="text-center">
        <div class="spinner-border" role="status"></div>
        <div class="mt-3 fw-semibold">Analyzing your fileâ€¦</div>
    </div>
</div>

<div class="container py-4">
    <div class="row mb-3">
        <div class="col-12 text-center">
            <h2 class="fw-bold">Excel Audit Tool</h2>
            <p class="text-muted mb-0">Upload your Audit sheet and check for formatting & content issues.</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left: Upload + Results -->
        <div class="col-lg-8">
            <!-- Upload Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" onsubmit="showLoader()">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Upload Excel file (.xlsx)</label>
                            <input type="file" name="file" accept=".xlsx,.xls" class="form-control" required />
                        </div>
                        <button class="btn btn-primary" type="submit">
                            Run Audit
                        </button>
                        {% if filename %}
                        <span class="ms-2 badge bg-secondary">File: {{ filename }}</span>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Messages -->
            {% if message %}
                <div class="alert alert-danger">{{ message }}</div>
            {% elif had_run and (errors|length == 0) %}
                <div class="alert alert-success">No issues found.</div>
            {% endif %}

            <!-- Errors Table -->
            {% if errors and errors|length > 0 %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Issues Found ({{ errors|length }})</h5>
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-sm table-striped align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 80px;">Cell</th>
                                        <th style="width: 40%;">Cell Value</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for e in errors %}
                                    <tr>
                                        <td><code>{{ e.cell if e.cell is defined else e["cell"] }}</code></td>
                                        <td>{{ e.value if e.value is defined else e["value"] }}</td>
                                        <td>
                                            {% set iss = e.issues if e.issues is defined else e["issues"] %}
                                            {% for i in iss %}
                                                <span class="badge text-bg-danger mb-1">{{ i }}</span><br/>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <a href="/download" class="btn btn-outline-secondary btn-sm">
                                Download error report
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Right: Summary Panel -->
        <div class="col-lg-4">
            <div class="card summary-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Audit Summary</h5>
                    {% if summary %}
                        {% set non_zero = [] %}
                        {% for k, v in summary.items() %}
                            {% if v > 0 %}
                                {% set _ = non_zero.append((k, v)) %}
                            {% endif %}
                        {% endfor %}

                        {% if non_zero|length == 0 %}
                            <p class="text-muted mb-0">No issues recorded in this run.</p>
                        {% else %}
                            <ul class="list-group list-group-flush">
                                {% for item in non_zero %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ item[0] }}</span>
                                        <span class="badge text-bg-primary rounded-pill">{{ item[1] }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-0">Run an audit to see summary statistics here.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showLoader() {
    const overlay = document.getElementById("loaderOverlay");
    if (overlay) {
        overlay.style.display = "flex";
    }
}
window.addEventListener("load", function() {
    const overlay = document.getElementById("loaderOverlay");
    if (overlay) {
        overlay.style.display = "none";
    }
});
</script>
</body>
</html>
